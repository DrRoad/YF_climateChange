---
title: "Uncertain projections"
author: "Katy Gaythorpe"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes: 
- \usepackage{placeins}
output: 
  pdf_document:
    df_print: "kable"
params:
  save_samples: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
knitr::opts_chunk$set(
  fig.path = paste0("Uncertain_projections_", Sys.Date(), "/"),
  dpi = 300,
  dev = c('png')
)
```

```{r set_up}

library(maptools)
library(sp) 
library(shapefiles)
library(Hmisc)
library(fields)
library(dplyr)
library(EnvStats)
library(readr)
library(reshape)
library(abind)
library(mvtnorm)
library(RColorBrewer)
library(truncdist)
library(tibble)
library(tidyr)

library(ggmcmc)
library(mcmcplots)
library(R.utils)

library(YFestimation)
library(snapalette)
library(KsetupR)

#########################################################################################################
### SETTING THE WORKING DIRECTORY ###
#########################################################################################################

shpdir = paste0("../","shapefiles/gadm2/")

#########################################################################################################
### LOADING SHAPEFILES AND COUNTRIES ###
#########################################################################################################

#read shapefiles in
shp0 = readShapePoly(paste0(shpdir, "Africa_adm0.shp")) #if gadm2
shp1 = readShapePoly(paste0(shpdir, "Africa_adm1.shp"))

#adjust titles
shp1$adm0_adm1 = paste(shp1$ISO, shp1$ID_1, sep="_")
shp1 = shp1[order(shp1$adm0_adm1),]

#read countries in
Countries = read_csv(paste0("../Data/","Countries.csv"))
c34 = Countries$c34
country34 = Countries$country34

#########################################################################################################
### SOURCE FUNCTIONS ###
#########################################################################################################

sourceDirectory("FUNCTIONS", modifiedOnly = FALSE)


snapal = "Camden"

```

# Visualising transmission intensity

## Direct values

```{r load_transmission}

transmission_proj = read.csv( "transmission_intensity_samples.csv", stringsAsFactors = FALSE)

transmission_proj = transmission_proj %>% mutate(year = as.character(year), scenario = as.character(scenario))

transmission_proj = transmission_proj %>% mutate(year = factor(year, levels = c("now", 2050, 2070)))

tp = filter(transmission_proj, !(scenario %in% c(45, 60, 85) & year == "now"))
tp$scenario[tp$year == "now"] = "now"

```

```{r transmission_by_country, fig.height = 12, fig.width = 10}
ggplot(tp) + 
  geom_violin(aes(x = scenario, y = FOI, fill = year), position="dodge", draw_quantiles = 0.5) + 
  facet_wrap(adm0~., scales = "free_y") +
  scale_fill_manual(values = snapalette(snapal, 3)) +
  theme_bw()

```

```{r transmission_by_country_subset, fig.height = 12, fig.width = 10}
ggplot( filter(tp, scenario %in% c("now",26, 85)) ) + 
  geom_violin(aes(x = scenario, y = FOI, fill = year), position="dodge", draw_quantiles = 0.5) + 
  facet_wrap(adm0~., scales = "free_y") +
  scale_fill_manual(values = snapalette(snapal, 3))+
  theme_bw()

```


```{r transmission_by_area}

west = c("BEN", "BFA", "GMB", "GHA", "GIN", "GNB", "CIV", "LBR", "MLI", "MRT", "NER", "NGA", "SEN", "SLE", "TGO")

tp = tp %>% mutate(WE = ifelse(adm0 %in% west, "West", "East and central"))

ggplot(tp) + 
  geom_violin(aes(x = scenario, y = FOI, fill = year), position="dodge", draw_quantiles = 0.5) + 
  facet_wrap(WE~.)+
  scale_fill_manual(values = snapalette(snapal, 3))+
  theme_bw()


```

```{r transmission_by_area_subset}

ggplot(filter(tp, scenario %in% c("now",26, 85))) + 
  geom_violin(aes(x = scenario, y = FOI, fill = year), position="dodge", draw_quantiles = 0.5) + 
  facet_wrap(WE~.)+
  scale_fill_manual(values = snapalette(snapal, 3))+
  theme_bw()

```

## Relative difference

```{r calc_diff}

percent_diff = transmission_proj

for(i in c(2050, 2070)){
  percent_diff[percent_diff$year == i, "FOI"] = (percent_diff[percent_diff$year == i, "FOI"] - percent_diff[percent_diff$year == "now", "FOI"])/
                                                    percent_diff[percent_diff$year == "now", "FOI"] * 100
}

```


```{r difference_by_country, fig.height = 12, fig.width = 10}

ggplot( filter(percent_diff, year %in% c(2050, 2070)) ) + 
  geom_violin(aes(x = scenario, y = FOI, fill = year), position="dodge", draw_quantiles = 0.5) + 
  facet_wrap(adm0~., scales = "free_y") + ylab("FOI change %")+
  scale_fill_manual(values = snapalette(snapal, 3))+
  theme_bw()


```

```{r difference_by_country_subset, fig.height = 12, fig.width = 10}

ggplot( filter(percent_diff, year %in% c(2050, 2070) & scenario %in% c(26, 85)) ) + 
  geom_violin(aes(x = scenario, y = FOI, fill = year), position="dodge", draw_quantiles = 0.5) + 
  facet_wrap(adm0~., scales = "free_y") + ylab("FOI change %")+
  scale_fill_manual(values = snapalette(snapal, 3))+
  theme_bw()


```

```{r difference_by_area}

percent_diff = percent_diff %>% mutate(WE = ifelse(adm0 %in% west, "West", "East and central"))

ggplot(filter(percent_diff, year %in% c(2050, 2070))) + 
  geom_violin(aes(x = scenario, y = FOI, fill = year), position="dodge", draw_quantiles = 0.5) + 
  facet_wrap(WE~.)+
  scale_fill_manual(values = snapalette(snapal, 3))+ 
  ylab("FOI change %")+
  theme_bw()

```


```{r difference_by_area_subset}

ggplot(filter(percent_diff, year %in% c(2050, 2070) & scenario %in% c(26, 85))) + 
  geom_violin(aes(x = scenario, y = FOI, fill = year), position="dodge", draw_quantiles = 0.5) + 
  facet_wrap(WE~.)+
  scale_fill_manual(values = snapalette(snapal, 3))+ ylab("FOI change %")+
  theme_bw()

```

# Visualising burden

```{r load_burden}

#get files in infections directory

fil = list.files("infections")

inf_in = NULL
for(i in 1:length(fil)){
  inf_in[[i]] = mutate_all( read.csv(paste0("infections/", fil[i]), stringsAsFactors = FALSE), as.character)
}

inf_in = bind_rows(inf_in)

inf_df = gather(inf_in,   "Year", "Infections", -c(adm0, scenario, sample))

inf_df$Year = gsub("X", "", inf_df$Year)

inf_df = inf_df %>% mutate( Year = as.character(Year), Infections = as.numeric(Infections))

```


```{r infections, fig.cap="Infections."}

ggplot(filter(inf_df, Year %in% c(2018, 2050, 2070)),
       aes(x = Year, y = log10(Infections), fill = scenario)) + 
  geom_violin( position="dodge", draw_quantiles = 0.5) + 
  scale_fill_manual(values = snapalette(snapal))+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

```{r infections_scenario_subset, fig.cap="Infections."}
tmp = filter(inf_df, 
             Year %in% c(2018, 2050, 2070) & 
                           scenario %in% c("26", "85", "now"))

ggplot(tmp,
       aes(x = Year, y = log10(Infections), fill = scenario)) + 
  geom_violin( position="dodge", draw_quantiles = 0.5) + 
  scale_fill_manual(values = snapalette(snapal)[c(1,4,5)])+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```